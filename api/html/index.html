<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>Unscented Kalman Filter Project: PID Control Project</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Unscented Kalman Filter Project
   &#160;<span id="projectnumber">0.1</span>
   </div>
   <div id="projectbrief">By Tony Lin</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="classPID.html">PID</a> Control Project </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Content of the Submission and Usage</h2>
<p>This submission includes the following c++ files:</p><ul>
<li>pid.cpp: the main function that communicates with the simulator and drive the <a class="el" href="classPID.html">PID</a> process.</li>
<li>twiddle.cpp: the main twiddle function for narrowing the <a class="el" href="classPID.html">PID</a> parameters</li>
<li>control/PID.[h, cpp]: the <a class="el" href="classPID.html">PID</a> controller</li>
<li><a class="el" href="Reducer_8h.html">utils/Reducer.h</a>: the <a class="el" href="classReducer.html">Reducer</a> class for sum, mean, min, max on a collection of samples.</li>
<li>tune/Twiddle.[h, cpp]: Provides twiddle implementation</li>
<li>tune/CarTwiddle.[h, cpp]: a subclass of <a class="el" href="classTwiddle.html">Twiddle</a> for a car model</li>
</ul>
<h3>Usage</h3>
<p><b>The <a class="el" href="classPID.html">PID</a> Controller</b> The <a class="el" href="classPID.html">PID</a> controller can be launched with the following command: </p><pre class="fragment">./pid [-s kp kd ki] [-v kp kd ki] [-max_speed speed]
</pre><p>Where:</p>
<ul>
<li>-s: specifies the <a class="el" href="classPID.html">PID</a> coefficients for steering. The default is: k<sub>p</sub> = 0.108, k<sub>d</sub> = 3.52, and k<sub>i</sub> = 0</li>
<li>-v: specifies the <a class="el" href="classPID.html">PID</a> coefficients for speed. The default is: k<sub>p</sub> = 13.5795, k<sub>d</sub>= -11.4359, and k<sub>i</sub> = 0</li>
<li>-max_speed, specify the maximal driving speed</li>
</ul>
<p>The program will listen on port 4567 for an incoming simulator connection. Only one simulator should be connected at anytime, though the program does not prohibit it. To start a new simulator, terminate the existing one first, then start a new one.</p>
<p>To start the simulator:</p>
<h4>On Windows</h4>
<pre class="fragment">term2_sim9.exe
</pre><h4>Other platforms:</h4>
<pre class="fragment">./term2_sim9
</pre><p><b>Launch <a class="el" href="classTwiddle.html">Twiddle</a></b> <a class="el" href="classTwiddle.html">Twiddle</a> can be launched with: </p><pre class="fragment">twiddle [-accel] [-steps steps] [-dt dt] [-y y] [-len length] [-target target] [-speed speed] [-drift drift]
</pre><p>Where:</p>
<ul>
<li>-accel: run twiddle for acceleration/deceleration coefficients, default is to run twiddle for steering coefficients</li>
<li>-steps: number of steps to move the vehicle in every run, default is 100</li>
<li>-dt: delta time for each step, default is 0.1</li>
<li>-y: the y coordinate of the vehicle, default is 1</li>
<li>-len: length of the vehicle between the front wheels and the center of mass, default is 2.5 (m)</li>
<li>-target: the target value to reach, default is 0</li>
<li>-speed: speed of the vehicle to simulate</li>
<li>drift: steering drift, default is 0</li>
</ul>
<h4>Build</h4>
<p>For Windows, Bash on Ubuntu on Windows should be used. Both gcc and clang can be used to build the program.</p>
<p>To build the program, invoke the following commands on the bash terminal: </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;mkdir build</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;cd build</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;cmake ..</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;make</div></div><!-- fragment --><p>The program can be built to output more information for disgnosis purposes by defining <b>VERBOSE_OUT</b> macro. In addition, the following macros can be defined:</p>
<ul>
<li>PLOT_WITH_MATPLOT: when defined on Mac, twiddle will use python matplotlib module to plot the <a class="el" href="classPID.html">PID</a> convergence diagram. In order to do this, tpython 2.7 with numpy, and matplotlib are required. Furthermore, on Bash on Windows, an X11 server is required and the DISPLAY environment need to be set accordingly.</li>
<li><p class="startli">STABILIZE_MOTION: when defined, the program will try to stabilize the vehicle. WHen this is defined, USE_MEAN_TURN can also be defined to use moving average of turns. Please refer to the <b>Steering</b> section. For example:</p>
<p class="startli">cmake -DSTABILIZE_MOTION=1 -DUSE_MEAN_TURN=1 ..</p>
</li>
</ul>
<h4>Build API Documentation</h4>
<p>The documentation for functions, classes and methods are included in the header files in Doxygen format. To generate Api documentation with the included doxygen.cfg:</p>
<ol type="1">
<li>Make sure doxygen is installed</li>
<li>cd to the root folder of this project</li>
<li><p class="startli">Issue the following command:</p>
<p class="startli">doxygen doxygen.cfg</p>
</li>
</ol>
<h2>The Implementation</h2>
<h3>The source code structure</h3>
<p>The src folder contains main.cpp, twiddle.cpp, and three folders: . tune: contains twiddle implementation files. . control: contains the <a class="el" href="classPID.html">PID</a> control class . utils: contains the <a class="el" href="classReducer.html">Reducer</a> class</p>
<h5>File names</h5>
<p>In this project, I made a class to have its own .h, and .cpp files. More specifically, a class source file contains exactly one class, and has the same name as the class it contains.</p>
<h4>The libs folder</h4>
<p>The libs folder contains Eigen, json.hpp, and matplotlibcpp.h.</p>
<h2><a class="el" href="classTwiddle.html">Twiddle</a> class</h2>
<p>The class implements twiddle algorithm in <b>twiddle()</b> method. Its subclass is required to implement the model simulation in the <b>run()</b> method.</p>
<h2><a class="el" href="classCarTwiddle.html">CarTwiddle</a> class</h2>
<p>This class implements a simple vehicle motion model that simulates the coordinate and yaw of a vehicle from the steering, velocity, acceleration and delta time. It is a subclass of <a class="el" href="classTwiddle.html">Twiddle</a>, and implements the <b>run()</b> method. The motion model is implements in <b>move()</b> method.</p>
<h2><a class="el" href="classPID.html">PID</a> class</h2>
<p>This class implements <a class="el" href="classPID.html">PID</a> controller. The <b>updateError()</b> is used to update the error, then the control value can be obtained from <b>getControl()</b> method. In addition to updating error, one can also update the value using <b>updateValue()</b> method, and the error will be computed from the target that can be set using <b>setTarget()</b> method.</p>
<h2><a class="el" href="classReducer.html">Reducer</a> class</h2>
<p>This class provides aggregation for a set of samples. This includes mean, weighted mean, sum, max, and min.</p>
<h2>Determine <a class="el" href="classPID.html">PID</a> coefficients</h2>
<p>Two <a class="el" href="classPID.html">PID</a> controllers are used in this project:</p>
<ul>
<li>Steering <a class="el" href="classPID.html">PID</a> controller: for controlling the steering so the car is driven as closed to the center as possible.</li>
<li>Acceleration <a class="el" href="classPID.html">PID</a> control: for controlling the acceleration and deceleration of vehicle. The project aimed to make the vehicle fast and furious. It decides the desirable speed according to the steering angle. Then the PIC controller is used to obtain the acceleration or deceleration.</li>
</ul>
<p>The twiddle program was used to help to narrow down the range of <a class="el" href="classPID.html">PID</a> coefficients to reduce the efforts of finding optimal coefficients.</p>
<p>For the acceleration <a class="el" href="classPID.html">PID</a> coefficients, the values produced by twiddle are used without further tuning. They seem working fine for the purpose.</p>
<p>The steering <a class="el" href="classPID.html">PID</a> coefficients, on the other hand, required a lot of tuning efforts to reduce oscillation, and produce reasonable controller outputs.</p>
<p>The convergence diagram of different <a class="el" href="classPID.html">PID</a> coefficients are shown in <a href="./convergence.png">this diagram</a>. The tuning process started with the coefficients returned from twiddle as follows:</p>
<ol type="1">
<li>If the vehicle has difficulties to stay on the road at turns, increase k<sub>p</sub>.</li>
<li>Otherwise, if the vehicle oscillates a lot, reduce k<sub>p</sub></li>
<li>Fine tune k<sub>d</sub>, if the vehicle shows lots of sharp movements, reduce the value, otherwise, increase the value if this yield better motion.</li>
</ol>
<p>The default <a class="el" href="classPID.html">PID</a> coefficients that are chosen for this project are:</p>
<p>k<sub>p</sub> = 0.108, k<sub>d</sub> = 3.52, and k<sub>i</sub> = 0 for steering</p>
<p>and</p>
<p>k<sub>p</sub> = 13.5795, k<sub>d</sub>= -11.4359, and k<sub>i</sub> = 0 for aceleration.</p>
<p>The k<sub>i</sub> in both controllers are 0 as no drift was assumed, and they seem fine with the simulator. Should a small amount of drift be applied for the acceleration <a class="el" href="classPID.html">PID</a>? I think it will depend on the road condition, so I decided to not to consider it.</p>
<h2>Steering</h2>
<p>The CTE values reported the simulator are updated to the steering <a class="el" href="classPID.html">PID</a> controller. The steering control value is then obtained from the <a class="el" href="classPID.html">PID</a> controller, then normalized to [-1 1] range.</p>
<p>The simulation shows large oscillation on curved road due to the following reasons:</p>
<ol type="1">
<li>The <a class="el" href="classPID.html">PID</a> process</li>
<li>When the vehicle is moved back to the center of the road, 0 steering will be sent back to the simulator. However, this should not be the case for curved road. Instead, the vehicle should be steered according to the curvature. This, unfortunately, cannot be obtained from the feedbacks provided by the simulator.</li>
</ol>
<p>To reduce oscillation, I have tried two approaches:</p>
<ol type="1">
<li>Use moving average of the steering control values to smooth out steering</li>
<li>Try to replace small spike in CTE with fewer wider CTE peaks.</li>
</ol>
<h3>Moving average</h3>
<p>In this approach, every steering control values generated by the <a class="el" href="classPID.html">PID</a> controllerto a reducer, and let the reducer compute weighted average of the values within a kernel of some certain size (5 currently).</p>
<h3>Reduce CTE Spikes</h3>
<p>Could we reduce CTE spikes by widen it so the car will oscillate less while still can manage to stay on the road? On approach that I have tried is to remove some portion of steering as follows:</p><ol type="1">
<li>Take the moving average of the past 20 to 40 angles or turns (30 in my case).</li>
<li>Take the moving average of the past 3 to 7 steerings (5 in my case), and substract it with the moving average from 1. This effectively applies two different filters on the steering, one low pass, and another high pass.</li>
</ol>
<h2>Throttling</h2>
<p>The vehicle speed is set according to the steering angle, the bigger the angle, the slower the speed should be for the vehicle to stay on the course. The <b><a class="el" href="pid__main_8cpp.html#afcea9d04c1a1c558749023bd1fcfd8d2">computeSpeedTarget()</a></b> function computes the fastest possible speed for the vehicle.</p>
<p>The difference between the target speed and the current speed reading is fed into the acceleration <a class="el" href="classPID.html">PID</a> controller. The output of the controller is the acceleration or deceleration for the vehicle.</p>
<p>The acceleration/deceleration is clamped to range [-20, 8], and then converted to a throttle value by the <b>computeThrottl()</b> function.</p>
<p>For acceleration, a minimal throttle value is required to keep the vehicle at the given speed, and extra throttle that is required to accelerate the vehicle is added.</p>
<p>For deceleration, the throttle will be set to a negative value, that is to brake the vehicle.</p>
<p>It also needs to be noted that the algorithm for computing the throttle from acceleration or deceleration is purely empirical. This is just like real world driving where we, at least for most people, will not know how fast the velicle will accelerate or decelerate when we step on the pedal or brake. We simply do until we have reached the target, and we step harder when we need things to happen faster.</p>
<h2>Results</h2>
<p>The following table shows the simulation result with different steering algorithms, including the videos recording during the simulations, the charts that show the curves of the speed, original steering, adjusted steering, mean, and CTE of the vehicle from the starting point to the bridge. The tuned steering <a class="el" href="classPID.html">PID</a> coefficients used for each algorithm are also shown.</p>
<table class="doxtable">
<tr>
<th align="left"></th><th align="center">Video </th><th align="center">Chart </th><th align="center"><a class="el" href="classPID.html">PID</a> Coefficients  </th></tr>
<tr>
<td align="left"><a class="el" href="classPID.html">PID</a> Only </td><td align="center"><a href="pid.mp4">Video</a> </td><td align="center"><a href="pid.png">Chart</a> </td><td align="center">kp=0.108, kd=3.52, ki=0 </td></tr>
<tr>
<td align="left">Weighted Moving Average </td><td align="center"><a href="ma.mp4">Video</a> </td><td align="center"><a href="ma.png">Chart</a> </td><td align="center">kp=0.075, kd=2.5, ki=0 </td></tr>
<tr>
<td align="left">Reduction using Mean Angle </td><td align="center"><a href="cm-angle.mp4">Video</a></td><td align="center"><a href="cm-angle.png">Chart</a> </td><td align="center">kp=0.13, kd=4, ki=0 </td></tr>
<tr>
<td align="left">Reduction using Mean Turn </td><td align="center"><a href="cm-turn.mp4">Video</a> </td><td align="center"><a href="cm-turn.png">Chart</a> </td><td align="center">kp=0.13, kd=4, ki=0 </td></tr>
</table>
<p>From the chart, we can observe the followings:</p>
<ol type="1">
<li>Moving average along did not reduce but increased the oscillation</li>
<li>By comparing the CTE curves on the charts, oscillation reduction using moving average did have reduced the oscillation, and was able to achieve a higher speed (up to <b>89Mph</b> has been observed).</li>
<li>Mean angle performed better than mean turn which had resulted in larger CTE.</li>
<li>Also observed in my experiments, oscillation reduction without using mean steering, and clamping changes in steering value may cause the vehicle to oscillate more.</li>
</ol>
<h3>Discussion</h3>
<p>The above algorithms require different <a class="el" href="classPID.html">PID</a> coefficients to reach certain stability. This, of course, might affect the characteristics of the performance curve shown in the above charts. But for being able to run the simulator at a higher speed with reduced oscillation, I think I have achieved the goal.</p>
<p>The extra works that I have done to stabilize the vehicle was to due a challenge from one of my friend in that, with <a class="el" href="classPID.html">PID</a> alone, it looked like the driver was drunk! I think the driver is less drunk with the oscillation reduction apparoch, or maybe just for fun! </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
